# Django allauth and Clusive

`django-allauth` is a library to support OAuth2 authorization using social
accounts such as Google+, Twitter, Github, and others.  This allows users to
log into Clusive using their social account credentials to log into Clusive, in 
addition to Clusive's current support for "local" login.

The `allauth` library was installed and its Google provider used to see how it
would work with Clusive.  The minimal work was done to determine if the usual
OAuth2 flow of information between the producer (Google) and the consumer
(Clusive) worked as expected.  That was limited to:

- providing UI on Clusive's end to support user requests to use their social
  account for authorization,
- setting up the requests between Clusive and Google to use the user's Google 
  credentials, specifically a link from Clusive to Google's login form,
- Clusive's listening for the response from Google.

Overall, adding the dialogs and code to Clusive was straight forward.  The main
effort was registering Clusive with Google's OAuth2 server.  That involved
filling in a number of forms to configure the calls from Google back to Clusive.
Note that this step is almost completely Google specific.  The only
Clusive/`django-allauth` requirement is setting the appropriate redirection URL
on Google's end.  This is the URL that Google uses after it has confirmed the
user's credentials and returns control back to Clusive.  `django-allauth` calls
it the "callback" uri.  The following URL was used for testing, where the actual
endpoint is taken from the `django-allauth` documentation:
`http://localhost:8000/accounts/google/login/callback/`

This document outlines the changes needed to use `django-allauth` with Clusive,
the lessons learned, and what else is needed to fully integrate with allauth.
It is based on the [Installation](https://django-allauth.readthedocs.io/en/latest/installation.html)
and [Google provider](https://django-allauth.readthedocs.io/en/latest/providers.html#google)
sections of the `django-allauth` documentation.

## UI
Changes to `settings.py` and `urls.py` are needed to add OAuth2 endpoints. This
adds a set of '/accounts/' endpoints.  Note that Clusive has  '/account/'
endpoints, so this does not immediatlely collide with Clusive's own login
system.  The following lists the ones experimented with:

- /accounts/login/
  - link to /accounts/login/ ("Sign In")
  - link to /accounts/signup/ ("Sign Up")
  - link to /accounts/google/login/
   - sends the user to Google login form
  - form for logging in (doesn't work out-of-the-box)

Other `/accounts/` end points provided by `django-allauth` are as follows.
Although not investigated, the names suggest these are for logging out, password
management, active/inactive accounts, anddemail management.  The last one,
`social`, is an unknown at this point.

- /accounts/logout/
- /accounts/password/
- /accounts/inactive/
- /accounts/email/
- /accounts/confirm-email/
- /accounts/social/

## Database

A new "Social Accounts" section is added with three new tables, named
"Social accounts", "Social application tokens", and "Social applications".

### Social applications

The social applications records contain data provided by the social OAuth2
server, but require filling in a couple of fields by hand after the consumer
(Clusive) has been registered with the provider (Google).  (Aside: there may be
a way to shift this to the user with a form on Clusive's end that asks the user
to confirm after returning from Google signin; need to investigate).  The two
fields that are generated by Google and need to be copied over are Clusive's
`client_id` and `client_secret`.  There may be an additional requirement of
adding them to `settings.py` in its `SOCIALACCOUNT_PROVIDERS` section, although
that needs further investigation.

- Provider: Google
- Name: Google -- user friendly name for use in UI
- Client Id: random characters generated by Google (OAuth2 client id)
- Secret Key: random characters generated by Google (OAuht2 client secret)
- Key:  Leave blank for Google
- Sites: "example.com"
  - a list of sites that offer their own signup and accounts.  In this case it
    should be Clusive's signup URL where Clusive accounts are created.
  - the names ("example.com") stored here reference Site records with the same
    domain name.  The SITES list also appears in `settings.py`.

### Social accounts

These are records containing information about social account users, including
information that is shared by the actual social account, e.g., user's Gmail
address. Creation of these records also cause the creation of an associated User
record.

- Id: SQL identifier
- User: cross reference to a User record's id
- Provider: OAuth2 provider; here, "Google"
- Uid: random characters
- Last login: date/time
- Date joined: date/time
- Extra data: JSON containing information from user's Google account:
  - Google account information that the user has agreed to share with Clusive
  - `id` field matches Uid above.
  - `picture` field happened to be added because I authorized Google to share
    that avatar.
  - `first_name`
  - `last_name`

Associated User record:
- User name: taken from Google shared information.
- Password: "No password set"
  - but, the actual record contains random characters, just not prefixed with
    `pbkdf2_sha256`, as legitimate passwords do.
  - access token?
- First name: taken from sharable data
- Last name: taken from sharable data
- Email address: taken from sharable data (empty if not shared)
- Permissions: "Active" checked
- Groups: empty
- User permissions: empty
- Last login: set to date/time of last login
- Date joined: set to date/time of when Google confirmed credentials
- Clusive Users (all fields set to default values):
  - Anon id: empty
  - Periods: empty
  - Current period: --
  - Library view: "Period assignments"
  - Library style: "bricks"
  - Permission: Test account
  - Role: Guest

### Social application tokens

This is where the access tokens received from OAuth2 providers are stored.  No
records were actually created, but that is likely because there is a step needed
on Clusive's end, namely, to handle allauth's (Clusive's) '/accounts/profile/'
end point.  Actually, it can be set to anything, but allauth defaults to
'/accounts/profile/' and does not provide a handler.
- Id: SQL identifier
- Token: random characters, likely the access token sent by provider
- Token secret: random characters, likely sent by provider
- Expires: date/time, usually 3600 seconds, likely sent by provider
- Account Id: cross references Social account record (i.e. link to User)
- App Id: cross references Social application record (i.e. link to Provider)

To be complete, the callback URL stored at Google's end is called like this
(however, I'm not sure of the information in the associated payload):

```
http://localhost:8000/accounts/google/login/callback/
  ?state=9TQ0n0KkxyeG
  &code=4%2F0AY0e-g7A0GgBQCQ98X-9F-0o5qRdCB75uVQyLEvPn65lxmUNKbGlQXlRYTqDMD_vlWU1Ag
  &scope=profile+https%3A%2F%2Fwww.googleapis.com%2Fauth%2Fuserinfo.profile
```

where,
- `state`: XSRF protection; generated by Clusive/allauth, echoed by Google
- `code`: access token generated by Google
- `scope`: generated by Google to indicate the scope of their authorization

After Clusive receives the above, `django-allauth` then reroutes to
`/accounts/profile/`, and 404s.

## Registering with Google

The `allauth` documentation suggests using a Google developer's account,
creating a Google project, and adding an OAuth2 client to that project.  The
Google dialogs/wizard for doing this are not intuitive.  The API documentation
helped (https://developers.google.com/identity/protocols/OAuth2). The result is
that Clusive is registered with Google, and with my developer account.  I have a
hard time seeing the average user going through these steps. But, when logging
in via another Google account, it properly called by the instance of CISL
running on my local machine.

A prerequisite for creating the OAuth2 credentials for Clusive is to fill out
an accompanying OAuth Consent Screen.  This gather information about Clusvie
some of which is presented to the user when they are redirected to their Google
sign-in page.  Here is an overview of what is needed and what I submitted:

- Name of app:  "Clusive"
- Publishing status: `Production` vs. `Testing` -- `Testing`
- User type: `Internal` or `External` -- `External`
  - Internal use is available only to "Google Workspace" users.  I cannot select this option.
  - External use means only a set of test users can use the service.
- Test users: none
  - List of users allowed when `Publishing status` is set to `Testing`
- OAuth rate limits: 100 grants per minute and 10,000 grants per day (default)
  - how often Clusive can use Google to verify new users.

# Next Steps

- actually integrate `django-allauth` with Clusive in terms of its look and feel
  and workflow
- compare with `python-social-auth.`
- potentially use the `django-allauth` provider code as guidance to implement a
  home grown provider for Clever.
  