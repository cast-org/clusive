{% extends "shared/base.html" %}
{% load figuration %}

{% block head_additional %}
<script>
    var all_words = {{ all_words | safe }};
    console.debug('all words: ', all_words);
</script>
{% endblock %}

{% block bodyClass %}library{% endblock %}

{% block title %}Customize | Clusive{% endblock %}

{% block header %}
{% include "shared/partial/site_header.html" %}
{% endblock %}

{% block sidebar_end %}
{% include "shared/partial/sidebar_end.html" with read_aloud=False lookup=False %}
{% endblock %}

{% load static figuration %}

{% block content %}
<main id="content" tabindex="-1">
    <h1>Edit Customization</h1>
    <p>Add a custom question {% comment TODO %}and/or vocabulary words{% endcomment %} for this reading.</p>
    <div class="library-list">
        {% include "library/partial/library_card_list.html" with direct_link=True show_assignments=True query=None %}
    </div>

    <div class="box">
        <h2>Edit {{ customization.title }} {% if is_new == 'true' %}(New){% endif %}</h2>
        <form method="post">
                {% csrf_token %}
            <div class="form-group">
                {{ form.title.label_tag | formlabel }} *
                {{ form.title.errors }}
                {{ form.title | formcontrol }}
            </div>
            <hr>
            <div class="form-group">
                {{ form.periods.label_tag | formlabel }}
                {{ form.periods.errors }}
                <p class="form-text">Select one or more classes:</p>
                <div class="container">
                    <div class="row">
                    {% for checkbox in form.periods %}
                        <div class="col-lg-4">
                            <div class="form-check form-checkradio">
                                {{ checkbox.tag | formcontrol }}
                                <label class="form-check-label" for="{{ checkbox.id_for_label }}">{{ checkbox.choice_label }}</label>
                            </div>
                        </div>
                    {% endfor %}
                    </div>
                </div>
            </div>
            <hr>
            <h3>Words:</h3>
            <div class="container mb-1">
                <div class="row vocabulary-word-list">
                {% for word in customization.word_list %}
                    <div class="col-lg-3 col-md-4 col-sm-6 vocabulary-word current-vocabulary-word">
                        {{ word }} <button id="delete_{{ word }}" class="link-btn delete-word-button" data-word="{{ word }}">x</button>
                    </div>
                {% empty %}
                    <span id="empty-vocabulary-list">None</span>
                {% endfor %}
                </div>
            </div>
            {{ form.current_vocabulary_words }}
            {{ form.new_vocabulary_words }}
            {{ form.delete_vocabulary_words }}
            <div class="form-inline">
                <label for="id_word_to_add" class="form-control sr-only">Add a word</label>
                <input type="text" id="id_word_to_add" class="form-control me-0_5">
                <button id="add-word-button" class="btn btn-primary">Add</button>
            </div>
            <p id="worderror" class="errorlist mt-0_5" style="display:none;">That word does not occur in this reading.</p>
            <p><a href="#" class="form-text mt=0_5" data-cfw="modal" data-cfw-modal-target="#modalWordSuggestions">See word suggestions</a></p>
            <div class="form-group">
                {{ form.question.label_tag | formlabel }}
                <p class="form-text">
                    This will appear in addition to the general knowledge
                    questions &quot;How much did you learn&quot; and
                    &quot;What's one thing you learned or found
                    interesting?&quot;
                </p>
                {{ form.question.errors }}
                <div class="mb-0_5">
                    <a href="#" class="btn btn-primary" data-cfw="dropdown">
                        Question starters
                        <span class="caret" aria-hidden="true"></span>
                    </a>
                    <ul class="dropdown-menu sentence-starter-menu" data-insert-into="{{ form.question.id_for_label }}">
                        <li><a href="#">Who is…</a></li>
                        <li><a href="#">What happened when…</a></li>
                        <li><a href="#">Where did…</a></li>
                        <li><a href="#">When did…</a></li>
                        <li><a href="#">Why do you think…</a></li>
                        <li><a href="#">What evidence is there for…</a></li>
                        <li><a href="#">What are you wondering about now?</a></li>
                        {% if recent_custom_questions %}
                        <li class="dropdown-divider"></li>
                        {% for q in recent_custom_questions %}
                        <li><a href="#">{{ q }}</a></li>
                        {% endfor %}
                        {% endif %}
                    </ul>
                </div>
                {{ form.question | formcontrol }}
            </div>
            <div>
                <hr>
                <input id="customization-edit-submit" type="submit" class="btn btn-secondary btn-small" value="Save"/>
                {% if is_new == 'true' %}
                <a href="{% url 'delete_customization' bk=customization.book.id ck=customization.id %}" class="btn btn-link btn-small">Cancel</a>
                {% else %}
                <a href="{% url 'customize_book' pk=customization.book.id %}" class="btn btn-link btn-small">Cancel</a>
                {% endif %}
            </div>
        </form>
    </div>
    {% include "library/partial/modal_word_suggestions.html" %}
</main>
<script>
    $('.sentence-starter-menu a').click(function(e) {
       e.preventDefault();
       var text = $(e.currentTarget).text().replace('…', ' ');
       var $input = $('#'+$(e.currentTarget).closest('.sentence-starter-menu').data('insert-into'));
       $input.val($input.val() + text);
       $input.focus();
    });

    // Build the vocabulary lists.
    $(document).ready(function () {
        cisl = cisl || {};
        cisl.customVocabs = {};
        cisl.customVocabs.currentList = $('#id_current_vocabulary_words').val().split('|');
        cisl.customVocabs.newList = [];
        cisl.customVocabs.deleteList = [];
    });

    // Transfer the final add and remove word lists to their respective hidden
    // <input>s.
    $('#customization-edit-submit').click(function (e) {
        $('#id_new_vocabulary_words').val(cisl.customVocabs.newList.join('|').trim());
        console.debug('On submit, <input> words to add: ' + $('#id_new_vocabulary_words').val());
        $('#id_delete_vocabulary_words').val(cisl.customVocabs.deleteList.join('|').trim());
        console.debug('On submit, <input> words to delete: ' + $('#id_delete_vocabulary_words').val());
    });

    $('#add-word-button').click(function (e) {
        addVocabularyWord(e);
    });

    $('#id_word_to_add').keypress(function (e) {
        var keycode = (e.keyCode ? event.keyCode : event.which);
        if (keycode == '13') {
            addVocabularyWord(e);
        }
    });

    $('.vocabulary-word-list').on('click', 'button', function (e) {
        deleteVocabularyWord(e);
    });

    function deleteVocabularyWord (e) {
        e.preventDefault();
        e.stopPropagation();
        var parentDiv = $(e.currentTarget).parent();
        var wordToDelete= $(e.currentTarget).attr('data-word');
        // Remove wordToDelete from the new words list, if present.
        var newResult = isNewWord(wordToDelete);
        if (newResult.index !== -1) {
            newResult.wordArray.splice(newResult.index);
        }
        else {
            // Note:  leave the current words list intact as it records the
            // actual current words -- a current word can appear in both the
            // current words list and the deleted words list, but a new word is
            // either in the new words list or not, and never in the deleted
            // words list.
            // Add wordToDelete to deleted words, but only once.
            var deleteResult = isDeletedWord(wordToDelete);
            if (deleteResult.index === -1) {
                deleteResult.wordArray.push(wordToDelete);
            }
        }
        // In all cases, removed the <div> containing the wordToDelete from the
        // document.  If all have been removed, put "None" instead.
        $(parentDiv).remove();
        if ($('div.vocabulary-word').length === 0) {
            $('.vocabulary-word-list').append('<span id="empty-vocabulary-list">None</span>');
        }
    };

    function addVocabularyWord(e) {
        e.preventDefault();
        e.stopPropagation();
        var inputField = $('#id_word_to_add');
        var newWord = inputField.val().trim();
        if (newWord.length) {
            if (!all_words.includes(newWord)) {
                $('#worderror').show();
                inputField.select();
                return;
            } else {
                $('#worderror').hide();
            }

            var condition = addCondition(newWord);
            if (condition === 'addNew' || condition === 'addAndRemoveFromDeleted') {
                var deleteButtonId = 'delete_' + newWord.replace(' ', '_');
                // Add the new <div> for the "new" vocabulary word.
                $('.vocabulary-word-list').append(`
                    <div class="col-lg-4 vocabulary-word new-vocabulary-word">
                        ${newWord} <button id="${deleteButtonId}" class="link-btn delete-word-button" data-word="${newWord}">x</button>
                    </div>
                `);
                var noWordsIndicator = $('#empty-vocabulary-list');
                if (noWordsIndicator[0]) {
                    noWordsIndicator.remove();
                }
                // Update word lists.
                if (condition === 'addNew') {
                    cisl.customVocabs.newList.push(newWord.trim());
                }
                else {  // condition === addAndRemoveFromDeleted
                    cisl.customVocabs.deleteList.splice(
                        cisl.customVocabs.deleteList.indexOf(newWord)
                    );
                }
            }
            else {
                console.log(`New word ${newWord} already added (condition is ${condition})`);
            }
        }
        inputField.val('');
        inputField.focus();
    };

    function isCurrentWord (word) {
        return isWordListMember(word, cisl.customVocabs.currentList);
    };

    function isNewWord (word) {
        return isWordListMember(word, cisl.customVocabs.newList);
    };

    function isDeletedWord (word) {
        return isWordListMember(word, cisl.customVocabs.deleteList);
    };

    function isWordListMember (word, wordList) {
        if (!wordList) {
            return { wordArray: [], index: -1 };
        }
        else {
            return { wordArray: wordList, index: wordList.indexOf(word) };
        }
    };

    function addCondition (word) {
        // If already in new word list, be done.
        newWord = isNewWord(word);
        if (newWord.index !== -1) {
            return 'dontAdd';
        }
        // Not in new word list.  Check the current words and the deleted words.
        // If a current word but not deleted, be done.
        currentWord = isCurrentWord(word);
        deletedWord = isDeletedWord(word);
        if (currentWord.index !== -1 && deletedWord.index === -1) {
            return 'dontAdd';
        }
        // If a current word and in the deleted list, remove from deleted, and
        // add back to display.
        if (currentWord.index !== -1 && deletedWord.index !== -1) {
            return 'addAndRemoveFromDeleted';
        }
        // Not in new list, nor a current word, simply add it.
        return 'addNew';
    };
</script>
{% endblock %}
