# Generated by Django 2.2.28 on 2022-07-21 18:43

import django.utils.timezone
from django.db import migrations, models


# When this field is added all add_dates will be set to 'now'.
# But we know that a book is at least as old as the oldest mod_date of its versions.
def calculate_reasonable_add_dates(apps, schema_editor):
    Book = apps.get_model('library', 'Book')
    for book in Book.objects.all():
        for bv in book.versions.all():
            if bv.mod_date < book.add_date:
                book.add_date = bv.mod_date
        book.save()

class Migration(migrations.Migration):

    dependencies = [
        ('library', '0050_auto_20220507_1036'),
    ]

    operations = [
        migrations.AddField(
            model_name='book',
            name='add_date',
            field=models.DateTimeField(auto_now_add=True, db_index=True, default=django.utils.timezone.now),
            preserve_default=False,
        ),
        migrations.AlterField(
            model_name='book',
            name='sort_author',
            field=models.CharField(db_index=True, max_length=256),
        ),
        migrations.AlterField(
            model_name='book',
            name='sort_title',
            field=models.CharField(db_index=True, max_length=256),
        ),
        migrations.RunPython(calculate_reasonable_add_dates, migrations.RunPython.noop),
    ]
