# Clever SSO Sequence

Note that the sequence is very similar to the one employed by Google SSO.

## Assumptions

### (I) Clusive is registered with Clever SSO Service

There are a series of dialogs to work through in order to register Clusive with
Clever's SSO service.  From a technical perspective, there a number of pieces
that are set by the registration process.

- `clientId`:
  - generated by Clever when registering Clusive as a client of Clever.
  - needs to be copied into Clusive's database -- see II below.
- `clientSecret`:
  - generated by Clever and copied to Clusive's database -- see II below.
- `redirectUri`:
  - created by Clusive, and stored in both Clusive's and Clever's databases
  - used by Clever to issue a request to Clusive after successful login 
  - e.g., https://cast.org/clusive/accounts/clever/
  - e.g., http://localhost:8000/accounts/clever/  (for testing)
- `scope`:
  - set as a property of Clusive at Clever's registration site
  - negotiated between CAST and Clever
  - determines the level of access that Clusive has to Clever's users, users'
   data, courses, and other Clever resources

### (II) Clusive maintains a database record identifying Clever

Note: using django-allauth paradigm in what follows.  The actual details may be
different:

Clusive creates a "Social application" record in its database that stores
information about Clever:
- `clientId`:
  - the same `clientId` generated by Clever from (I) above.  This is used to
    confirm Clusive's identity with Clever.
- `clientSecret`:
   - the same `clientSecret` generated by Clever from (I) above, also for
     confirmation.
- `provider`:
   - the Social app identifier, e.g., "clever"
- `name`:
   - user friendly name of the Social application, e.g., "Clever"

## Sequence:

Given the above are set up, the sequence of requests and responses between
Clusive and Clever is as follows.  There are a few places where it is not clear
what is going on; these are presented in *emphasized text*.

From the "Sign In with Clusive" button [demo](https://clever.com/in/ssodemo):

This button is part of Clusive's sign-in page.  Clicking it takes the user
to Clever's web site and its login UI, via a GET request:

1. Clicking the the button invokes a GET request for Clever's login form:
```
GET
https://clever.com/oauth/sis/login/
?target=clientId
```
The `target` is the `clientId` from (I).  This allows Clever to find the
`redirectUri` in its database for calling back to Clusive.

Also, Clusive is allowed to specifuy a different `redirectUri` in the request
than that specified during registration (I).  Clever will use that redirect
instead.  (Comment:  I'm not sure of the use case for sending a different
redirect.  Maybe there is one, but it seems less secure than the uri prearranged 
by both parties during registration).

The above was taken from the [Library SSO with OAuth 2.0](https://dev.clever.com/docs/classroom-with-oauth)
documentation.  Other documentation suggests this GET request is different.  From
the [Login with Clever](https://dev.clever.com/docs/identity-api#log-in-with-clever)
section of the [District SSO with OAuth2.0](https://dev.clever.com/docs/identity-api)
document:
```
GET 
https://clever.com/oauth/authorize
?response_type=code
&redirect_uri=https%3A%2F%cast.org/accounts/clever  the uri registered at (I)
&client_id=`clientId` the `clientId` registered at (I)
```
Note that the use of an `/authorize` endpoint complies with the [OAuth2
specification](https://tools.ietf.org/html/rfc6749#section-4.1.10).

2. Clever presents a login form with username and password fields.  Submitting
the form issues a POST request of Clever itself.  Since this all happens on
Clever's site, there is nothing for Clusive to do at this step.  It's noted
here for completeness.
```
POST https://clever.com/oauth/sis/login/
target=clientId
user_type=""
username=userName (user's Clever account username)
password=password (user's Clever account password)
```

3. Clever verifies the username/password, and then issues a GET request back to
Clusive using the `redirectUri` from (I) above.
```
GET
https://cast.org/clusive/accounts/clever/
?`code`=random characters generated by Clever when making this request (one-time)
&`scope`=scope value agreed to during registration (I)
&`state`=provided by Clusive as part of the "Login with Clever" link/request,
step 1 above.
```

The `state` paremeter is supplied only when using the "Log In With Clever"
button (this scenario); however, *the documentation does not say how this is 
passed at step 1.*

Clusive will need to keep track of the `code` value and retrieve the `clientId`
and `clientSecret` from its database, specificallyk from its Clever Social
application record.

4. Clusive POSTs back to Clever to acquire access tokens:
```
POST https://clever.com/oauth/tokens/
Content-Type: either "application/x-www-form-urlencoded" or "application/json"; using JSON here
Authorization: "Basic " + Base64.encode(clientId + ":" + clientSecret)
Content-Length: Length of the json below.
{
    "code": generated by Clever and sent at step 3.  Clusive echoes it back to Clever,
    "grant_type": "authorization_code",
    "redirect_uri": "https://cast.org/clusive/accounts/clever/" `redirectUri` from (I)
}
```
 
5. Clever checks the `code`, `clientId`, `clientSecret`, and `redirect_uri`
sent by Clusive.  If they don't match Clever's records, Clever denies access to 
its resources with a `403` (unauthorized).  If they do match, Clever sends a 
response back to Clusive with an access token:
```
200 OK
Content-type: application/json
Content-length: size of the json object
{ "access_token": random characters }
```

6. Using the just-received access token value, Clusive GETs the user's Clever
Id, district Id and user type:
```
GET
https://api.clever.com/v2.1/me/
Authorization: Bearer access_token value from step 5.
```

7. Clever responds with (*this is somewhat of a guess based on the description
in Clever's documentation*):
```
200 OK
Content-type: application/json
Content-length: size of the json object
{ "cleverUserId": <cleverUserId>, "districtId": <districtId>, "userType": <userType> }
```

8. Clusive creates "User", "Social account" and "Social application tokens"
cross referenced records to store the access token from Clever and persist other
information about the user.  Clusive uses the access token value for both
internal requests and requests to Clever.  Note that the access token has an
expiry date, typically one hour.  There is a way to refresh the access token,
*but it's not clear how based on Clever's documentation.  Clever might follow
the OAuth2 specification in this regard; this is something to investigate
further*

  - User record:
    - the usual -- up to Clusive as to what it wants to store here.
    - *store Clever's `districtId` here?*
    - *Clever's `userType`?*

  - Social account record:
    - `id`: sql identifier,
    - `user_id`: id of the User record,
    - `provider`: "Clever",
    - `uid`: random characters, *?? Clever `cleverUserId`? or a `django-allauth`-ism ?*
    - `last_login`: datetime,
    - `date_joined`: datetime,
    - `extra_data`: JSON, *`districtId` and `userType` here?*

  - Social applications token record:
    - `id`: sql identifier,
    - `token`: value of `access_token` sent from Clever at step 5,
    - `token_secret`: text (*from where?  `django-allauth`-ism?*),
    - `expires_at`: date time, usually 3600 sec from reception (1 hour),
    - `account_id`: id of associated "Social account record" for the user
       corresponding to this token,
    - `app_id`: id of the "Social application" record from (II) above
       representing the Clever app

From here on, Clusive uses the access token value to access Clever resources. For
example, if the value of the access token is `2YotnFZFEjr1zCsicMWpAA`:
```
GET
https://api.clever.com/resource1
Authorization: Bearer `2YotnFZFEjr1zCsicMWpAA`
```

Similary, Clusive would use the access token "Bearer" authorization for access
to its own resources.

## Clever Portal SSO

The sequence described above is what happens when Clusive uses the "Login with
Clever" sign-on button.  Another way for Clever users to access Clusive is via
Clusive's portal.  The portal appears as a desktop with large icons representing
apps and tools that the Clever user can use.  One of these can be Clusive. In
that case, the sequence is slightly different.

Assuming that the user is already logged into Clever, and seeing their portal:

1. Clever issues a GET request to itself:
```
GET
https://clever.com/oauth/instant-login
?client_id=`clientId` the `clientId` set up during registration (I)
&district_id=`districtId`  the Clever district the user is signed in to.
```
Thereafter the sequence is the same as above, beginning at step 3.

## References:
- [Library SSO with OAuth 2.0](https://dev.clever.com/docs/classroom-with-oauth)
- [District SSO with OAuth 2.0](https://dev.clever.com/docs/identity-api)
